<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main-layout}">
<head>
    <title>Club Update</title>
    <style>
        #search-container {
            width: 45%;
            float: left;
            margin: 10px;
        }

        #map {
            width: 50%;
            height: 400px;
            float: right;
            margin-top: 20px;
            border: 1px solid #ccc;
        }

        /* í¬ê¸° ê°•ì œ ì„¤ì • */
        #search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .result-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .result-item:hover {
            background-color: #f0f0f0;
        }

        .selected {
            background-color: #e0f7fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div layout:fragment="content" class="container mt-5">
    <h1>í¬ë£¨ ìƒì„¸ì •ë³´ ìˆ˜ì •í•˜ê¸°</h1>
    <form th:action="@{/clubs/update}" method="post" id="clubForm" class="needs-validation" novalidate
          enctype="multipart/form-data">
        <!-- Hidden ID -->
        <input type="hidden" name="id" th:value="${clubUpdate.id}">

        <!-- Title -->
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" name="title" id="title" class="form-control" th:value="${clubUpdate.title}" required>
            <div class="invalid-feedback">ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- Content -->
        <div class="mb-3">
            <label for="content" class="form-label">Content</label>
            <textarea name="content" id="content" class="form-control" rows="4" th:text="${clubUpdate.content}"
                      required></textarea>
            <div class="invalid-feedback">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- ì£¼ì†Œ ê²€ìƒ‰ -->
        <div class="mb-3">
            <label for="search-query" class="form-label">ì£¼ì†Œ ê²€ìƒ‰</label>
            <input type="text" id="search-query" class="form-control" th:value="${clubUpdate.location}"
                   placeholder="ì£¼ì†Œ ê²€ìƒ‰">
            <button type="button" onclick="searchAddress()" class="btn btn-primary mt-2">ê²€ìƒ‰</button>
        </div>
        <div  class="mb-3" id="search-container">
            <div id="search-results"></div>
        </div>
        <div  class="mb-3"  id="map"></div>
        <input  name="location" id="location" th:value="${clubUpdate.location}" required>
        <input  name="locationTitle" id="locationTitle" th:value="${clubUpdate.locationTitle}" required>
        <input  name="latitude" id="latitude" th:value="${clubUpdate.latitude}" required>
        <input  name="longitude" id="longitude" th:value="${clubUpdate.longitude}" required>

        <!-- Age Restriction -->
        <div class="mb-3">
            <label for="ageRestriction" class="form-label create-name text-dark">ê°€ì… ì¡°ê±´ ë‚˜ì´ ğŸ‚</label>
            <input type="number" name="ageRestriction" id="ageRestriction" class="form-control border-primary"
                   placeholder="20ì„¸ ì´ìƒ ì…ë ¥" step="1" th:value="${clubUpdate.ageRestriction}" required>
            <div class="invalid-feedback">20ì„¸ ì´ìƒ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ‘¶</div>
        </div>

        <!-- Theme -->
        <div class="mb-3">
            <label for="selectedTheme" class="form-label create-name text-dark">í‚¤ì›Œë“œ ìˆ˜ì •ğŸ¨</label>
            <select name="selectedTheme" id="selectedTheme" class="form-select border-primary" required>
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì•¡í‹°ë¹„í‹°" th:selected="${clubUpdate.selectedTheme == 'ì•¡í‹°ë¹„í‹°'}">ì•¡í‹°ë¹„í‹° ğŸƒ</option>
                <option value="ìê¸°ê³„ë°œ" th:selected="${clubUpdate.selectedTheme == 'ìê¸°ê³„ë°œ'}">ìê¸°ê³„ë°œ ğŸ“š</option>
                <option value="ì·¨ë¯¸" th:selected="${clubUpdate.selectedTheme == 'ì·¨ë¯¸'}">ì·¨ë¯¸ ğŸ®</option>
                <option value="ì—¬í–‰" th:selected="${clubUpdate.selectedTheme == 'ì—¬í–‰'}">ì—¬í–‰ âœˆï¸</option>
                <option value="ë¬¸í™”/ì˜ˆìˆ " th:selected="${clubUpdate.selectedTheme == 'ë¬¸í™”/ì˜ˆìˆ '}">ë¬¸í™”/ì˜ˆìˆ  ğŸ­</option>
                <option value="í‘¸ë“œ/ë“œë§í¬" th:selected="${clubUpdate.selectedTheme == 'í‘¸ë“œ/ë“œë§í¬'}">í‘¸ë“œ/ë“œë§í¬ ğŸ”</option>
            </select>
            <div class="invalid-feedback">í…Œë§ˆë¥¼ ê³¨ë¼ì£¼ì„¸ìš”! ğŸ¤”</div>
        </div>

        <!-- ì´ë¯¸ì§€ ìˆ˜ì • -->
        <div class="mb-3">
            <label for="clubFile" class="form-label">ì‚¬ì§„ ì—…ë¡œë“œğŸ³ (ìƒˆë¡œìš´ ì‚¬ì§„ìœ¼ë¡œ êµì²´)</label>
            <input type="file" name="clubFile" id="clubFile" class="form-control" multiple accept="image/*">
            <small class="form-text text-muted">ìƒˆë¡œìš´ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ê¸°ì¡´ ì‚¬ì§„ì´ êµì²´ë©ë‹ˆë‹¤.</small>
            <div th:if="${clubUpdate.fileAttached == 1}" class="mt-3">
                <h6>í˜„ì¬ ë“±ë¡ëœ ì‚¬ì§„</h6>
                <div class="d-flex flex-wrap gap-3">
                    <img th:each="fileName : ${clubUpdate.storedFileName}" th:src="@{|/upload/${fileName}|}"
                         class="img-thumbnail" style="max-width: 150px; max-height: 150px;" alt="í˜„ì¬ ì‚¬ì§„">
                </div>
            </div>
            <div id="preview" class="mt-3 d-flex flex-wrap gap-3"></div>
        </div>

        <!-- Submit -->
        <button type="submit" class="btn btn-primary">ìˆ˜ì •í•˜ê¸°</button>
        <a th:href="@{/clubs}" class="btn btn-secondary">Back to List</a>
    </form>
    <script>
        // ì´ˆê¸° ì§€ë„ ì„¤ì •
        let map;
        let markers = [];
        let infoWindows = [];
        let selectedMarker = null;

        $(document).ready(function () {
            // Age Restriction ì‹¤ì‹œê°„ ê²€ì¦
            $('#ageRestriction').on('input', function () {
                let age = parseInt($(this).val());

                if (age < 20) {
                    alert("ë‚˜ì´ë¥¼ ë‹¤ì‹œ ì„¤ì •í•˜ì„¸ìš”"); // ê²½ê³ ì°½ ì¶”ê°€
                    $(this).val(20); // ì…ë ¥ê°’ì„ 20ìœ¼ë¡œ ìë™ ìˆ˜ì •
                    $(this).addClass('is-invalid'); // Bootstrap ë“±ì˜ í´ë˜ìŠ¤ í™œìš© ì‹œ ì‹œê°ì  ê²½ê³ 
                } else {
                    $(this).removeClass('is-invalid'); // ì •ìƒ ì…ë ¥ì¼ ê²½ìš° ê²½ê³  ì œê±°
                }
            });
            // ì§€ë„ ì´ˆê¸°í™”
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng([[${
                    clubUpdate
                    .latitude != null ? clubUpdate.latitude : 37.5665
                }]], [[${clubUpdate.longitude != null ? clubUpdate.longitude : 126.9780}]]),
                zoom: 14
            });

            // ì´ˆê¸° ë§ˆì»¤ ì„¤ì •
            const initialLat = [[${clubUpdate.latitude != null ? clubUpdate.latitude : 37.5665}]];
            const initialLng = [[${clubUpdate.longitude != null ? clubUpdate.longitude : 126.9780}]];
            const initialMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(initialLat, initialLng),
                map: map
            });
            markers.push(initialMarker);
            const initialInfoWindow = new naver.maps.InfoWindow({
                content: `<div style="padding:10px;">[[${clubUpdate.locationTitle}]]</div>`
            });
            infoWindows.push(initialInfoWindow);
            initialMarker.addListener('click', () => initialInfoWindow.open(map, initialMarker));

            // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
            $('#clubFile').on('change', function (event) {
                const preview = $('#preview');
                preview.empty();
                const files = event.target.files;
                if (files) {
                    $.each(files, function (index, file) {
                        if (file.type.match('image.*')) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                const img = $('<img>').attr('src', e.target.result)
                                    .css({'max-width': '200px', 'max-height': '200px'});
                                preview.append(img);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });

            // Bootstrap í¼ ê²€ì¦
            $('#clubForm').on('submit', function (event) {
                const form = this;
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        });

        function searchAddress() {
            console.log('searchAddress called'); // ë””ë²„ê¹… ë¡œê·¸

            const query = document.getElementById('search-query').value;
            fetch(`/api/server/naver?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Search results:', data); // ë””ë²„ê¹… ë¡œê·¸
                    markers.forEach(marker => marker.setMap(null));
                    infoWindows.forEach(info => info.close());
                    markers = [];
                    infoWindows = [];

                    const resultList = document.getElementById('search-results');
                    resultList.innerHTML = '';
                    data.forEach((place, index) => {
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.innerHTML = `<strong>${place.title}</strong><br>${place.address}`;
                        item.onclick = () => selectAddress(place, index, item);
                        resultList.appendChild(item);

                        const lat = place.mapy / 1e7;
                        const lng = place.mapx / 1e7;
                        const position = new naver.maps.LatLng(lat, lng);
                        const marker = new naver.maps.Marker({
                            position: position,
                            map: map,
                            title: place.title,
                            address:place.address

                        });
                        markers.push(marker);

                        // ì •ë³´ ì°½ ìƒì„±
                        const infoWindow = new naver.maps.InfoWindow({
                            content: `<div style="padding:10px;"><strong>${place.title}</strong><br>${place.address}</div>`
                        });
                        infoWindows.push(infoWindow);


                        // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ ì°½ ì—´ê¸° ë° ì„ íƒ
                        naver.maps.Event.addListener(marker, 'click', () => {
                            selectAddress(place, index, item);
                        });
                    });

                    if (data.length > 0) {
                        if (data.length === 1) {
                            map.setCenter(new naver.maps.LatLng(data[0].mapy / 1e7, data[0].mapx / 1e7));
                            map.setZoom(14);
                        } else {
                            const bounds = new naver.maps.LatLngBounds();
                            data.forEach(place => bounds.extend(new naver.maps.LatLng(place.mapy / 1e7, place.mapx / 1e7)));
                            map.fitBounds(bounds);
                        }
                    }
                })
                .catch(error => console.error('Search error:', error));
        }

        function selectAddress(place, index, itemElement) {
            if (selectedMarker) selectedMarker.setIcon(null);
            document.querySelectorAll('.result-item').forEach(item => item.classList.remove('selected'));

            itemElement.classList.add('selected');
            selectedMarker = markers[index];
            selectedMarker.setIcon({
                url: 'http://static.naver.net/maps2/icons/pin_spot2.png',
                size: new naver.maps.Size(24, 37)
            });
            const cleanTitle = place.title.replace(/<[^>]+>/g, '');
            document.getElementById('location').value = place.address;
            document.getElementById('locationTitle').value = cleanTitle
            document.getElementById('latitude').value = place.mapy / 1e7;
            document.getElementById('longitude').value = place.mapx / 1e7;

            map.panTo(markers[index].getPosition());
            infoWindows[index].open(map, markers[index]);
        }
    </script>
</div>

</body>
</html>