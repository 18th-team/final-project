<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main-layout}">
<head>
    <title>Club Update</title>
    <style>
        #search-container {
            width: 45%;
            float: left;
            margin: 10px;
        }

        #map {
            width: 50%;
            height: 400px;
            float: right;
            margin-top: 20px;
            border: 1px solid #ccc;
        }

        /* 크기 강제 설정 */
        #search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .result-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .result-item:hover {
            background-color: #f0f0f0;
        }

        .selected {
            background-color: #e0f7fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div layout:fragment="content" class="container mt-5">
    <h1>크루 상세정보 수정하기</h1>
    <form th:action="@{/clubs/update}" method="post" id="clubForm" class="needs-validation" novalidate
          enctype="multipart/form-data">
        <!-- Hidden ID -->
        <input type="hidden" name="id" th:value="${clubUpdate.id}">

        <!-- Title -->
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" name="title" id="title" class="form-control" th:value="${clubUpdate.title}" required>
            <div class="invalid-feedback">제목을 입력해주세요.</div>
        </div>

        <!-- Content -->
        <div class="mb-3">
            <label for="content" class="form-label">Content</label>
            <textarea name="content" id="content" class="form-control" rows="4" th:text="${clubUpdate.content}"
                      required></textarea>
            <div class="invalid-feedback">내용을 입력해주세요.</div>
        </div>

        <!-- 주소 검색 -->
        <div class="mb-3">
            <label for="search-query" class="form-label">주소 검색</label>
            <input type="text" id="search-query" class="form-control" th:value="${clubUpdate.location}"
                   placeholder="주소 검색">
            <button type="button" onclick="searchAddress()" class="btn btn-primary mt-2">검색</button>
        </div>
        <div  class="mb-3" id="search-container">
            <div id="search-results"></div>
        </div>
        <div  class="mb-3"  id="map"></div>
        <input  name="location" id="location" th:value="${clubUpdate.location}" required>
        <input  name="locationTitle" id="locationTitle" th:value="${clubUpdate.locationTitle}" required>
        <input  name="latitude" id="latitude" th:value="${clubUpdate.latitude}" required>
        <input  name="longitude" id="longitude" th:value="${clubUpdate.longitude}" required>

        <!-- Age Restriction -->
        <div class="mb-3">
            <label for="ageRestriction" class="form-label create-name text-dark">가입 조건 나이 🎂</label>
            <input type="number" name="ageRestriction" id="ageRestriction" class="form-control border-primary"
                   placeholder="20세 이상 입력" step="1" th:value="${clubUpdate.ageRestriction}" required>
            <div class="invalid-feedback">20세 이상 나이를 입력해주세요! 👶</div>
        </div>

        <!-- Theme -->
        <div class="mb-3">
            <label for="selectedTheme" class="form-label create-name text-dark">키워드 수정🎨</label>
            <select name="selectedTheme" id="selectedTheme" class="form-select border-primary" required>
                <option value="">선택하세요</option>
                <option value="액티비티" th:selected="${clubUpdate.selectedTheme == '액티비티'}">액티비티 🏃</option>
                <option value="자기계발" th:selected="${clubUpdate.selectedTheme == '자기계발'}">자기계발 📚</option>
                <option value="취미" th:selected="${clubUpdate.selectedTheme == '취미'}">취미 🎮</option>
                <option value="여행" th:selected="${clubUpdate.selectedTheme == '여행'}">여행 ✈️</option>
                <option value="문화/예술" th:selected="${clubUpdate.selectedTheme == '문화/예술'}">문화/예술 🎭</option>
                <option value="푸드/드링크" th:selected="${clubUpdate.selectedTheme == '푸드/드링크'}">푸드/드링크 🍔</option>
            </select>
            <div class="invalid-feedback">테마를 골라주세요! 🤔</div>
        </div>

        <!-- 이미지 수정 -->
        <div class="mb-3">
            <label for="clubFile" class="form-label">사진 업로드🍳 (새로운 사진으로 교체)</label>
            <input type="file" name="clubFile" id="clubFile" class="form-control" multiple accept="image/*">
            <small class="form-text text-muted">새로운 파일을 선택하면 기존 사진이 교체됩니다.</small>
            <div th:if="${clubUpdate.fileAttached == 1}" class="mt-3">
                <h6>현재 등록된 사진</h6>
                <div class="d-flex flex-wrap gap-3">
                    <img th:each="fileName : ${clubUpdate.storedFileName}" th:src="@{|/upload/${fileName}|}"
                         class="img-thumbnail" style="max-width: 150px; max-height: 150px;" alt="현재 사진">
                </div>
            </div>
            <div id="preview" class="mt-3 d-flex flex-wrap gap-3"></div>
        </div>

        <!-- Submit -->
        <button type="submit" class="btn btn-primary">수정하기</button>
        <a th:href="@{/clubs}" class="btn btn-secondary">Back to List</a>
    </form>
    <script>
        // 초기 지도 설정
        let map;
        let markers = [];
        let infoWindows = [];
        let selectedMarker = null;

        $(document).ready(function () {
            // Age Restriction 실시간 검증
            $('#ageRestriction').on('input', function () {
                let age = parseInt($(this).val());

                if (age < 20) {
                    alert("나이를 다시 설정하세요"); // 경고창 추가
                    $(this).val(20); // 입력값을 20으로 자동 수정
                    $(this).addClass('is-invalid'); // Bootstrap 등의 클래스 활용 시 시각적 경고
                } else {
                    $(this).removeClass('is-invalid'); // 정상 입력일 경우 경고 제거
                }
            });
            // 지도 초기화
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng([[${
                    clubUpdate
                    .latitude != null ? clubUpdate.latitude : 37.5665
                }]], [[${clubUpdate.longitude != null ? clubUpdate.longitude : 126.9780}]]),
                zoom: 14
            });

            // 초기 마커 설정
            const initialLat = [[${clubUpdate.latitude != null ? clubUpdate.latitude : 37.5665}]];
            const initialLng = [[${clubUpdate.longitude != null ? clubUpdate.longitude : 126.9780}]];
            const initialMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(initialLat, initialLng),
                map: map
            });
            markers.push(initialMarker);
            const initialInfoWindow = new naver.maps.InfoWindow({
                content: `<div style="padding:10px;">[[${clubUpdate.locationTitle}]]</div>`
            });
            infoWindows.push(initialInfoWindow);
            initialMarker.addListener('click', () => initialInfoWindow.open(map, initialMarker));

            // 파일 미리보기
            $('#clubFile').on('change', function (event) {
                const preview = $('#preview');
                preview.empty();
                const files = event.target.files;
                if (files) {
                    $.each(files, function (index, file) {
                        if (file.type.match('image.*')) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                const img = $('<img>').attr('src', e.target.result)
                                    .css({'max-width': '200px', 'max-height': '200px'});
                                preview.append(img);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });

            // Bootstrap 폼 검증
            $('#clubForm').on('submit', function (event) {
                const form = this;
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        });

        function searchAddress() {
            console.log('searchAddress called'); // 디버깅 로그

            const query = document.getElementById('search-query').value;
            fetch(`/api/server/naver?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Search results:', data); // 디버깅 로그
                    markers.forEach(marker => marker.setMap(null));
                    infoWindows.forEach(info => info.close());
                    markers = [];
                    infoWindows = [];

                    const resultList = document.getElementById('search-results');
                    resultList.innerHTML = '';
                    data.forEach((place, index) => {
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.innerHTML = `<strong>${place.title}</strong><br>${place.address}`;
                        item.onclick = () => selectAddress(place, index, item);
                        resultList.appendChild(item);

                        const lat = place.mapy / 1e7;
                        const lng = place.mapx / 1e7;
                        const position = new naver.maps.LatLng(lat, lng);
                        const marker = new naver.maps.Marker({
                            position: position,
                            map: map,
                            title: place.title,
                            address:place.address

                        });
                        markers.push(marker);

                        // 정보 창 생성
                        const infoWindow = new naver.maps.InfoWindow({
                            content: `<div style="padding:10px;"><strong>${place.title}</strong><br>${place.address}</div>`
                        });
                        infoWindows.push(infoWindow);


                        // 마커 클릭 시 정보 창 열기 및 선택
                        naver.maps.Event.addListener(marker, 'click', () => {
                            selectAddress(place, index, item);
                        });
                    });

                    if (data.length > 0) {
                        if (data.length === 1) {
                            map.setCenter(new naver.maps.LatLng(data[0].mapy / 1e7, data[0].mapx / 1e7));
                            map.setZoom(14);
                        } else {
                            const bounds = new naver.maps.LatLngBounds();
                            data.forEach(place => bounds.extend(new naver.maps.LatLng(place.mapy / 1e7, place.mapx / 1e7)));
                            map.fitBounds(bounds);
                        }
                    }
                })
                .catch(error => console.error('Search error:', error));
        }

        function selectAddress(place, index, itemElement) {
            if (selectedMarker) selectedMarker.setIcon(null);
            document.querySelectorAll('.result-item').forEach(item => item.classList.remove('selected'));

            itemElement.classList.add('selected');
            selectedMarker = markers[index];
            selectedMarker.setIcon({
                url: 'http://static.naver.net/maps2/icons/pin_spot2.png',
                size: new naver.maps.Size(24, 37)
            });
            const cleanTitle = place.title.replace(/<[^>]+>/g, '');
            document.getElementById('location').value = place.address;
            document.getElementById('locationTitle').value = cleanTitle
            document.getElementById('latitude').value = place.mapy / 1e7;
            document.getElementById('longitude').value = place.mapx / 1e7;

            map.panTo(markers[index].getPosition());
            infoWindows[index].open(map, markers[index]);
        }
    </script>
</div>

</body>
</html>