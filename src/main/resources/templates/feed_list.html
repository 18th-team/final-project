<html layout:decorate="~{layouts/main-layout}" layout:fragment="content">
<link rel="stylesheet" th:href="@{/css/community.css}">
<body class="bg-light">

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
        <div>
            <a class="feed-tab active" th:href="@{/feed/list}">ÏßÄÍ∏à ÌîºÎìú</a>
            <a class="feed-tab non-active" th:href="@{/review/list}">Î™®ÏûÑ ÌõÑÍ∏∞</a>
        </div>
        <a th:href="@{/feed/create}" class="btn" id="write-btn">ÌîºÎìú Ïì∞Í∏∞</a>
    </div>


    <!-- Í≤ÄÏÉâ Ï∞Ω -->
    <div class="row">
        <div class="col mt-3">
            <form class="d-flex align-items-right" role="search" action="/feed/list" method="get">
                <input type="text" class="form-control search-bar" name="keyword" placeholder="Ï†úÎ™©, ÎÇ¥Ïö©, ÏûëÏÑ±Ïûê, ÌÉúÍ∑∏Î°ú Í≤ÄÏÉâÌïòÍ∏∞">
            </form>
        </div>
    </div>

    <!-- ÌÉ≠ Ïª®ÌÖêÏ∏† -->
    <div class="tab-content" id="communityTabContent">
        <!-- ÏßÄÍ∏à ÌîºÎìú -->
        <div class="tab-pane fade show active" id="feed-tab-pane" role="tabpanel" aria-labelledby="feed-tab"
             tabindex="0">
            <div class="row row-cols-1 row-cols-md-2 g-4 mt-3" id="feed-container"
                 data-masonry='{"percentPosition": true }'>
                <div class="col" th:each="feed : ${feedList}">
                    <div class="post-card">
                        <div class="d-flex align-items-center">
                            <img th:src="${feed.author.profileImage != null ? feed.author.profileImage : '/img/default-profile.png'}"
                                 class="rounded-circle me-2 img-fluid" style="width: 40px; height: 40px;">
                            <div>
                                <div class="post-author" th:text="${feed.author.name}">ÏûëÏÑ±Ïûê</div>
                                <div class="post-time"
                                     th:text="${#temporals.format(feed.createDate, 'yyyy-MM-dd HH:mm')}">ÏûëÏÑ±Ïùº
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <img th:if="${feed.imageURL != null and !feed.imageURL.isEmpty()}" th:src="${feed.imageURL}" class="img-fluid rounded mb-2" alt="ÌîºÎìú Ïù¥ÎØ∏ÏßÄ"
                                 style="width: 100%; height:auto;">
                            <h5 th:text="${feed.title}">Ï†úÎ™©</h5>
                            <p class="mb-2" th:text="${feed.content}">ÎÇ¥Ïö©</p>
                            <div class="hashtags">
                                <div class="hashtags">
                                    <a th:each="tag : ${feed.tagList}"
                                       th:href="@{'/feed/list?keyword=' + ${tag}}"
                                       th:text="'#' + ${tag}"
                                       class="me-1 text-decoration-none text-muted hashtag">
                                    </a>
                                </div>



                            </div>
                        </div>
                        <div class="icons mt-3">
                            <a href="javascript:void(0);"
                               class="like-btn text-decoration-none"
                               th:data-post-id="${feed.postID}"
                               th:data-liked="${feed.voter.contains(loginUser)}"
                               th:data-like-count="${#lists.size(feed.voter)}">
    <span th:if="${feed.voter.contains(loginUser)}"
          th:text="'üß°' + ${#lists.size(feed.voter)}"></span>
                                <span th:unless="${feed.voter.contains(loginUser)}"
                                      th:text="'ü§ç' + ${#lists.size(feed.voter)}"></span>
                            </a>

                            <span class="ms-3 comment-toggle" th:attr="data-post-id=${feed.postID}">

                                üí¨ <span th:text="${commentCountMap[feed.postID]}">0</span>
                            </span>

                        </div>

                        <!-- icons ÏïÑÎûòÏóê Ï∂îÍ∞Ä -->
                        <div class="mt-2 d-flex justify-content-end"
                             th:if="${loginUser != null and loginUser.id == feed.author.id}">
                            <a th:href="@{'/feed/modify/' + ${feed.postID}}"
                               class="btn btn-sm btn-outline-secondary me-2">ÏàòÏ†ï</a>
                            <a th:href="@{'/feed/delete/' + ${feed.postID}}" class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</a>
                        </div>

                    </div>
                </div>
            </div>

            <div class="text-center mt-4" th:if="${hasMore}">
                <button id="loadMoreBtn" class="btn btn-outline-primary">ÎçîÎ≥¥Í∏∞</button>
            </div>
        </div>

        <!-- ÎåìÍ∏Ä Î™®Îã¨ -->
        <div class="modal fade" id="commentModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ÎåìÍ∏Ä</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ÎåìÍ∏Ä Î™©Î°ù -->
                        <div id="commentListContainer">
                            <div th:each="feed : ${feedList}" class="comment-list d-none"
                                 th:id="'comment-list-' + ${feed.postID}">
                                <div th:each="comment : ${allComments[feed.postID]}">
                                    <img th:src="${comment.author.profileImage != null ? comment.author.profileImage : '/img/default-profile.png'}"
                                         class="rounded-circle me-2"
                                         style="width: 35px; height: 35px; object-fit: cover;">
                                    <strong th:text="${comment.author.name}">ÏûëÏÑ±Ïûê</strong>
                                    <div th:text="${comment.content}">ÎÇ¥Ïö©</div>

                                    <button type="button"
                                            class="btn btn-sm btn-link reply-btn"
                                            th:data-parent-id="${comment.id}"
                                            th:data-post-id="${feed.postID}">
                                        ÎãµÍ∏Ä Îã¨Í∏∞
                                    </button>

                                    <div class="reply-form mt-2 d-none" th:id="'reply-form-' + ${comment.id}">
                                        <textarea class="form-control mb-2 reply-content" rows="2"
                                                  placeholder="ÎãµÍ∏Ä ÏûÖÎ†•"></textarea>
                                        <button type="button" class="btn btn-sm btn-primary submit-reply">Îì±Î°ù</button>
                                    </div>

                                    <div th:each="reply : ${comment.children}" class="ms-4 border-start ps-2 mt-2">
                                        <img th:src="${reply.author.profileImage != null ? reply.author.profileImage : '/img/default-profile.png'}"
                                             class="rounded-circle me-2"
                                             style="width: 30px; height: 30px; object-fit: cover;">
                                        <strong th:text="${reply.author.name}">ÏûëÏÑ±Ïûê</strong>
                                        <div th:text="${reply.content}">ÎãµÍ∏Ä</div>

                                        <!-- ÎãµÍ∏Ä ÏÇ≠Ï†ú Î≤ÑÌäº -->
                                        <div class="text-end"
                                             th:if="${loginUser != null and reply.author.id == loginUser.id}">
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger delete-comment-btn"
                                                    th:data-comment-id="${reply.id}"
                                                    th:data-post-id="${feed.postID}">
                                                ÏÇ≠Ï†ú
                                            </button>
                                        </div>

                                        <div class="text-muted"
                                             th:text="${#temporals.format(reply.createDate, 'yyyy-MM-dd HH:mm')}">ÏûëÏÑ±Ïùº
                                        </div>
                                        <hr>
                                    </div>


                                    <div class="text-end"
                                         th:if="${loginUser != null and comment.author.id == loginUser.id}">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger delete-comment-btn"
                                                th:data-comment-id="${comment.id}"
                                                th:data-post-id="${feed.postID}">
                                            ÏÇ≠Ï†ú
                                        </button>

                                    </div>
                                    <div class="text-muted"
                                         th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}">ÏûëÏÑ±Ïùº
                                    </div>
                                    <hr>
                                </div>
                            </div>
                        </div>

                        <!-- ÎåìÍ∏Ä ÏûëÏÑ± Ìèº -->
                        <form id="commentForm">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="postID" id="commentPostID">
                            <textarea class="form-control mb-2" name="content" id="commentContent"
                                      placeholder="ÎåìÍ∏Ä ÏûÖÎ†•"></textarea>
                            <button type="submit" class="btn btn-primary">Îì±Î°ù</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script layout:fragment="script">

    let msnry;

    // Masonry ÏàòÎèô Ï¥àÍ∏∞Ìôî (ÌéòÏù¥ÏßÄ Ï≤òÏùå Î°úÎìúÎê† Îïå)
    $(window).on('load', function () {
        msnry = new Masonry('#feed-container', {
            itemSelector: '.col',
            percentPosition: true
        });
    });

    let offset = 4;
    const limit = 4;

    document.getElementById("loadMoreBtn").addEventListener("click", function () {
        $.ajax({
            url: "/feed/more",
            type: "GET",
            data: {offset, limit},
            success: function (posts) {
                if (posts.length === 0) {
                    $("#loadMoreBtn").hide();
                    return;
                }

                const newElems = [];

                posts.forEach(post => {
                    const $newCard = $(`
                    <div class="col">
                        <div class="post-card">
                            <div class="d-flex align-items-center">
                                <img src="${post.author.profileImage || '/img/default-profile.png'}" class="rounded-circle me-2 img-fluid" style="width: 40px; height: 40px;">
                                <div>
                                    <div class="post-author">${post.author.name}</div>
                                    <div class="post-time">${new Date(post.createDate).toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <img src="${post.imageURL}" class="img-fluid rounded mb-2" alt="ÌîºÎìú Ïù¥ÎØ∏ÏßÄ" style="width: 100%; height:auto;">
                                <h5>${post.title}</h5>
                                <p class="mb-2">${post.content}</p>
                                <div class="hashtags">
  ${
                        post.tags.split(',').map(tag =>
                            `<a href="/feed/list?keyword=${tag.trim()}" class="me-1 text-decoration-none text-muted hashtag">#${tag.trim()}</a>`
                        ).join('')
                    }
</div>

                            </div>
                            <div class="icons mt-3">
                                <span>ü§ç 0</span>
                                <span class="ms-3">üí¨ 0</span>
                            </div>
                        </div>
                    </div>
                `);

                    $("#feed-container").append($newCard);
                    newElems.push($newCard[0]);
                });

                imagesLoaded('#feed-container', function () {
                    msnry.appended(newElems);
                    msnry.layout(); // Ïù¥Îïå Ï†ïÌôïÌïú ÎÜíÏù¥ Í≥ÑÏÇ∞Îê® ‚Üí Í≤πÏπ® ÏóÜÏùå
                });

                offset += posts.length;

                if (posts.length < limit) {
                    $("#loadMoreBtn").hide();
                }
            },
            error: function () {
                alert("ÌîºÎìúÎ•º Îçî Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            }
        });
    });


    $(document).ready(function () {
        

        // ÎåìÍ∏Ä Î™®Îã¨ Ïó¥Í∏∞
        $(".comment-toggle").on("click", function () {
            const postID = $(this).data("post-id");
            $("#commentPostID").val(postID);

            $(".comment-list").addClass("d-none");
            $(`#comment-list-${postID}`).removeClass("d-none");

            const modal = new bootstrap.Modal(document.getElementById('commentModal'));
            modal.show();
        });

        // ÎåìÍ∏Ä Îì±Î°ù
        $("#commentForm").on("submit", function (e) {
            e.preventDefault();

            const postID = $("#commentPostID").val();
            const content = $("#commentContent").val();
            const csrfToken = $("input[name='_csrf']").val();

            $.ajax({
                url: "/comment/feed",
                type: "POST",
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                data: {
                    postID: postID,
                    content: content,
                    _csrf: csrfToken
                },
                success: function () {
                    const commentHtml = `
                        <strong>ÎÇò</strong>
                        <div>${content}</div>
                        <div class="text-muted">${new Date().toLocaleString()}</div>
                        <hr>
                    `;
                    $(`#comment-list-${postID}`).append(commentHtml);
                    $("#commentContent").val(""); // ÏûÖÎ†•Ï∞Ω ÎπÑÏö∞Í∏∞
                },
                error: function () {
                    alert("ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®");
                }
            });
        });
    });

    $(document).on("click", ".delete-comment-btn", function () {
        if (!confirm("ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;

        const commentId = $(this).data("comment-id");
        const postId = $(this).data("post-id");
        const csrfToken = $("input[name='_csrf']").val();

        $.ajax({
            url: `/comment/feed/delete/${commentId}`,
            type: "POST",
            data: {
                _csrf: csrfToken
            },
            success: function () {
                // Ìï¥Îãπ ÎåìÍ∏Ä DOM Ï†úÍ±∞
                $(`#comment-list-${postId} .delete-comment-btn[data-comment-id='${commentId}']`)
                    .closest("div").parent().remove(); // ÎåìÍ∏Ä div Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
            },
            error: function () {
                alert("ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®");
            }
        });
    });

    // ÎãµÍ∏Ä Îã¨Í∏∞ Î≤ÑÌäº ÎàåÎ†ÄÏùÑ Îïå ÏûÖÎ†•Ï∞Ω Î≥¥Ïó¨Ï£ºÍ∏∞
    $(document).on("click", ".reply-btn", function () {
        const parentId = $(this).data("parent-id");
        $(`#reply-form-${parentId}`).toggleClass("d-none");
    });

    // ÎãµÍ∏Ä Îì±Î°ù Ï≤òÎ¶¨
    $(document).on("click", ".submit-reply", function () {
        const $form = $(this).closest(".reply-form");
        const parentId = $form.attr("id").split("-")[2];
        const content = $form.find(".reply-content").val();
        const postId = $("#commentPostID").val();
        const csrfToken = $("input[name='_csrf']").val();

        $.ajax({
            url: "/comment/feed/reply",
            type: "POST",
            data: {
                postId: postId,
                parentId: parentId,
                content: content,
                _csrf: csrfToken
            },
            success: function () {
                const replyHtml = `
                <div class="ms-4 border-start ps-2 mt-2">
                    <img src="/img/default-profile.png" class="rounded-circle me-2" style="width:30px; height:30px;">
                    <strong>ÎÇò</strong>
                    <div>${content}</div>
                    <div class="text-muted">${new Date().toLocaleString()}</div>
                    <hr>
                </div>`;
                $(`#reply-form-${parentId}`).before(replyHtml);
                $form.find(".reply-content").val("");
                $form.addClass("d-none");
            },
            error: function () {
                alert("ÎãµÍ∏Ä Îì±Î°ù Ïã§Ìå®");
            }
        });
    });

    $(document).on("click", ".like-btn", function () {
        const $btn = $(this);
        const postId = $btn.data("post-id");

        $.ajax({
            url: `/feed/vote/${postId}`,
            type: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            success: function () {
                // ÌòÑÏû¨ ÌïòÌä∏ ÏÉÅÌÉú ÏùΩÍ∏∞
                const liked = $btn.data("liked");
                let count = parseInt($btn.data("like-count"));

                // ÏÉÅÌÉú ÌÜ†Í∏Ä
                const newLiked = !liked;
                const newCount = newLiked ? count + 1 : count - 1;

                // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                $btn.data("liked", newLiked);
                $btn.data("like-count", newCount);

                // ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                $btn.html(`${newLiked ? "üß°" : "ü§ç"} ${newCount}`);
            },
            error: function () {
                alert("Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ïã§Ìå®!");
            }
        });
    });

</script>


</body>
</html>
