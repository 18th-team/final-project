<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main-layout}"
      layout:fragment="content">
<link rel="stylesheet" th:href="@{/css/community.css}">
<body class="bg-light">

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
        <div>
            <a class="feed-tab active" th:href="@{/post/feed/list}">ÏßÄÍ∏à ÌîºÎìú</a>
            <a class="feed-tab non-active" th:href="@{/post/review/list}">Î™®ÏûÑ ÌõÑÍ∏∞</a>
        </div>
        <a th:href="@{/post/feed/create}" class="btn" id="write-btn">ÌîºÎìú Ïì∞Í∏∞</a>
    </div>


    <!-- Í≤ÄÏÉâ Ï∞Ω -->
    <div class="row">
        <div class="col mt-3">
            <form class="d-flex align-items-right" role="search" th:action="@{/post/feed/list}" method="get">
                <input type="text" class="form-control search-bar" name="keyword" placeholder="Ï†úÎ™©, ÎÇ¥Ïö©, ÏûëÏÑ±Ïûê, ÌÉúÍ∑∏Î°ú Í≤ÄÏÉâÌïòÍ∏∞">
            </form>
        </div>
    </div>

    <!-- ÌÉ≠ Ïª®ÌÖêÏ∏† -->
    <div class="tab-content" id="communityTabContent">
        <!-- ÏßÄÍ∏à ÌîºÎìú -->
        <div class="tab-pane fade show active" id="feed-tab-pane" role="tabpanel" aria-labelledby="feed-tab"
             tabindex="0">
            <div class="row row-cols-1 row-cols-md-2 g-4 mt-3" id="feed-container"
                 data-masonry='{"percentPosition": true }'>
                <div class="col" th:each="post : ${postList}">
                    <div class="post-card">
                        <div class="d-flex align-items-center">
                            <img th:src="${post.author.profileImage != null ? post.author.profileImage : '/img/default-profile.png'}"
                                 class="rounded-circle me-2 img-fluid" style="width: 40px; height: 40px;">
                            <div>
                                <div class="post-author" th:text="${post.author.name}">ÏûëÏÑ±Ïûê</div>
                                <div class="post-time" th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}">ÏûëÏÑ±Ïùº</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <img th:if="${post.imageURL != null and !post.imageURL.isEmpty()}" th:src="${post.imageURL}" class="img-fluid rounded mb-2" alt="ÌîºÎìú Ïù¥ÎØ∏ÏßÄ"
                                 style="width: 100%; height:auto;">
                            <h5 th:text="${post.title}">Ï†úÎ™©</h5>
                            <p class="mb-2" th:text="${post.content}">ÎÇ¥Ïö©</p>
                            <div class="hashtags">
                                <a th:each="tag : ${post.tagList}"
                                   th:href="@{'/post/feed/list?keyword=' + ${tag}}"
                                   th:text="'#' + ${tag}"
                                   class="me-1 text-decoration-none text-muted hashtag"></a>
                            </div>
                        </div>

                        <div class="icons mt-3">
                            <a href="javascript:void(0);"
                               class="like-btn text-decoration-none"
                               th:data-post-id="${post.postID}"
                               th:data-liked="${post.voter.contains(loginUser)}"
                               th:data-like-count="${#lists.size(post.voter)}">
                                <span th:if="${post.voter.contains(loginUser)}" th:text="'üß°' + ${#lists.size(post.voter)}"></span>
                                <span th:unless="${post.voter.contains(loginUser)}" th:text="'ü§ç' + ${#lists.size(post.voter)}"></span>
                            </a>
                            <span class="ms-3 comment-toggle" th:attr="data-post-id=${post.postID}">
                    üí¨ <span th:text="${commentCountMap[post.postID]}">0</span>
                </span>
                        </div>

                        <div class="mt-2 d-flex justify-content-end"
                             th:if="${loginUser != null and loginUser.id == post.author.id}">
                            <a th:href="@{'/post/modify/' + ${post.postID}}" class="btn btn-sm btn-outline-secondary me-2">ÏàòÏ†ï</a>
                            <a th:href="@{'/post/delete/' + ${post.postID}}" class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</a>
                        </div>
                    </div>
                </div>
            </div>


            <div class="text-center mt-4" th:if="${hasMore}">
                <button id="loadMoreBtn" class="btn btn-outline-primary mb-5">ÎçîÎ≥¥Í∏∞</button>
            </div>
        </div>

        <!-- ÎåìÍ∏Ä Î™®Îã¨ -->
        <div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ÎåìÍ∏Ä</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Îã´Í∏∞"></button>
                    </div>
                    <div class="modal-body">

                        <!-- ÎåìÍ∏Ä Î™©Î°ù -->
                        <div th:each="post : ${postList}" th:id="'comment-list-' + ${post.postID}" class="comment-list d-none">
                            <div th:each="comment : ${commentMap[post.postID]}"
                                 th:id="'comment-' + ${comment.id}" class="mb-3">

                                <!-- ÌîÑÎ°úÌïÑ Î∞è ÏûëÏÑ±Ïûê -->
                                <div>
                                    <img th:src="${comment.author.profileImage != null ? comment.author.profileImage : '/img/default-profile.png'}"
                                         class="rounded-circle me-2" style="width:30px; height:30px;">
                                    <strong th:text="${comment.author.name}">ÏûëÏÑ±Ïûê</strong>
                                </div>

                                <!-- ÎåìÍ∏Ä Î≥∏Î¨∏ -->
                                <div class="comment-content" th:text="${comment.content}">ÎåìÍ∏Ä ÎÇ¥Ïö©</div>
                                <div class="text-muted small" th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}">ÏûëÏÑ±Ïùº</div>

                                <!-- ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº -->
                                <div th:if="${loginUser != null and loginUser.id == comment.author.id}">
                                    <button type="button" class="btn btn-sm btn-outline-secondary edit-comment-btn"
                                            th:data-comment-id="${comment.id}">ÏàòÏ†ï</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-comment-btn"
                                            th:data-comment-id="${comment.id}" th:data-post-id="${post.postID}">ÏÇ≠Ï†ú</button>
                                </div>

                                <!-- ÎãµÍ∏Ä Î≤ÑÌäº -->
                                <button type="button" class="btn btn-sm btn-link reply-btn" th:data-parent-id="${comment.id}">ÎãµÍ∏Ä</button>

                                <!-- ÎãµÍ∏Ä Ìèº -->
                                <div th:id="'reply-form-' + ${comment.id}" class="reply-form mt-2 d-none">
                                    <textarea class="form-control reply-content" rows="2" placeholder="ÎãµÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                                    <button type="button" class="btn btn-sm btn-primary mt-1 submit-reply">Îì±Î°ù</button>
                                </div>

                                <!-- ÎåÄÎåìÍ∏Ä -->
                                <div th:each="child : ${comment.children}"
                                     th:id="'comment-' + ${child.id}"
                                     class="ms-4 border-start ps-3 mt-3">

                                    <img th:src="${child.author.profileImage != null ? child.author.profileImage : '/img/default-profile.png'}"
                                         class="rounded-circle me-2" style="width:30px; height:30px;">
                                    <strong th:text="${child.author.name}">ÏûëÏÑ±Ïûê</strong>

                                    <div class="comment-content" th:text="${child.content}">ÎãµÍ∏Ä ÎÇ¥Ïö©</div>
                                    <div class="text-muted small" th:text="${#temporals.format(child.createDate, 'yyyy-MM-dd HH:mm')}">ÏûëÏÑ±Ïùº</div>

                                    <div th:if="${loginUser != null and loginUser.id == child.author.id}">
                                        <button type="button" class="btn btn-sm btn-outline-secondary edit-comment-btn"
                                                th:data-comment-id="${child.id}">ÏàòÏ†ï</button>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-comment-btn"
                                                th:data-comment-id="${child.id}" th:data-post-id="${post.postID}">ÏÇ≠Ï†ú</button>
                                    </div>
                                </div>
                                <hr>
                            </div>
                        </div>

                        <!-- ÎåìÍ∏Ä ÏûëÏÑ± Ìèº -->
                        <form id="commentForm" class="mt-3">
                            <input type="hidden" id="commentPostID" name="postID" />
                            <textarea id="commentContent" name="content" class="form-control" rows="3" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required></textarea>
                            <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-primary mt-2">ÎåìÍ∏Ä Îì±Î°ù</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>


    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script layout:fragment="script">
    $(function () {
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        $(document).ajaxSend(function (e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });
    });

    let msnry;

    // Masonry ÏàòÎèô Ï¥àÍ∏∞Ìôî (ÌéòÏù¥ÏßÄ Ï≤òÏùå Î°úÎìúÎê† Îïå)
    $(window).on('load', function () {
        imagesLoaded('#feed-container', function () {
            msnry = new Masonry('#feed-container', {
                itemSelector: '.col',
                percentPosition: true
            });
        });
    });

    let offset = 4;
    const limit = 4;
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    // "ÎçîÎ≥¥Í∏∞" Î≤ÑÌäºÏù¥ Ï°¥Ïû¨Ìï† ÎïåÎßå Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener("click", function () {
            $.ajax({
                url: "/post/feed/more",
                type: "GET",
                data: { offset, limit },
                success: function (posts) {
                    if (posts.length === 0) {
                        $("#loadMoreBtn").hide();
                        return;
                    }

                    const newElems = [];

                    posts.forEach(post => {
                        if (post.boardType !== "FEED") return;
                        const $newCard = $(`
                        <div class="col">
                            <div class="post-card">
                                <div class="d-flex align-items-center">
                                    <img src="${post.authorProfileImage || '/img/default-profile.png'}" class="rounded-circle me-2 img-fluid" style="width: 40px; height: 40px;">
                                    <div>
                                        <div class="post-author">${post.authorName}</div>
                                        <div class="post-time">${new Date(post.createDate).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <img src="${post.imageURL}" class="img-fluid rounded mb-2" alt="ÌîºÎìú Ïù¥ÎØ∏ÏßÄ" style="width: 100%; height:auto;">
                                    <h5>${post.title}</h5>
                                    <p class="mb-2">${post.content}</p>
                                    <div class="hashtags">
                                        ${
                            post.tags.split(',').map(tag =>
                                `<a href="/post/feed/list?keyword=${tag.trim()}" class="me-1 text-decoration-none text-muted hashtag">#${tag.trim()}</a>`
                            ).join('')
                        }
                                    </div>
                                </div>
                                <div class="icons mt-3">
                                    <span>ü§ç 0</span>
                                    <span class="ms-3">üí¨ 0</span>
                                </div>
                            </div>
                        </div>
                    `);

                        $("#feed-container").append($newCard);
                        newElems.push($newCard[0]);
                    });

                    imagesLoaded('#feed-container', function () {
                        msnry.appended(newElems);
                        msnry.layout(); // Ï†ïÌôïÌïú ÎÜíÏù¥ Í≥ÑÏÇ∞
                    });

                    offset += posts.length;

                    if (posts.length < limit) {
                        $("#loadMoreBtn").hide();
                    }
                },
                error: function () {
                    alert("ÌîºÎìúÎ•º Îçî Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                }
            });
        });
    } else {
        console.log("ÎçîÎ≥¥Í∏∞ Î≤ÑÌäºÏù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
    }



    $(document).ready(function () {


        // ÎåìÍ∏Ä Î™®Îã¨ Ïó¥Í∏∞
        $(".comment-toggle").on("click", function () {
            const postID = $(this).data("post-id");
            $("#commentPostID").val(postID);

            $(".comment-list").addClass("d-none");
            $(`#comment-list-${postID}`).removeClass("d-none");

            const modal = new bootstrap.Modal(document.getElementById('commentModal'));
            modal.show();
        });

        // ÎåìÍ∏Ä Îì±Î°ù
        $("#commentForm").on("submit", function (e) {
            e.preventDefault();

            const postID = $("#commentPostID").val();
            const content = $("#commentContent").val();

            const csrfToken = $("meta[name='_csrf']").attr("content");
            const csrfHeader = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: "/comment",
                type: "POST",
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                headers: {
                    [csrfHeader]: csrfToken
                },
                data: {
                    postID: postID,
                    content: content
                },
                success: function () {
                    const commentHtml = `
                        <strong>ÎÇò</strong>
                        <div>${content}</div>
                        <div class="text-muted">${new Date().toLocaleString()}</div>
                        <hr>
                    `;
                    $(`#comment-list-${postID}`).append(commentHtml);
                    $("#commentContent").val(""); // ÏûÖÎ†•Ï∞Ω ÎπÑÏö∞Í∏∞
                },
                error: function (xhr) {
                    console.log("ÏÉÅÌÉú ÏΩîÎìú:", xhr.status);
                    console.log("ÏùëÎãµ ÌÖçÏä§Ìä∏:", xhr.responseText);
                    alert("ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®: " + xhr.status);
                }
            });
        });
    });

    // ÏàòÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÏûÖÎ†•Ï∞Ω ÌÜ†Í∏Ä
    $(document).on("click", ".edit-comment-btn", function () {
        const commentId = $(this).data("comment-id");
        const $commentDiv = $(`#comment-${commentId}`);
        const originalContent = $commentDiv.find(".comment-content").text();

        const editForm = `
        <div class="edit-form mt-2">
            <textarea class="form-control edit-content" rows="2">${originalContent}</textarea>
            <button class="btn btn-sm btn-primary mt-1 submit-edit" data-comment-id="${commentId}">ÏàòÏ†ï ÏôÑÎ£å</button>
        </div>`;

        $commentDiv.append(editForm);
    });

    $(document).on("click", ".submit-edit", function () {
        const commentId = $(this).data("comment-id");
        const newContent = $(this).siblings(".edit-content").val();

        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        const csrfToken = $("meta[name='_csrf']").attr("content");

        $.ajax({
            url: `/comment/edit/${commentId}`,
            type: "POST",
            data: {
                content: newContent,
                _csrf: csrfToken
            },
            success: function () {
                // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
                const $commentBlock = $(`#comment-${commentId}`);
                $commentBlock.find(".comment-content").text(newContent);
                $commentBlock.find(".edit-form").remove();
            },
            error: function (xhr) {
                alert("ÏàòÏ†ï Ïã§Ìå®: " + xhr.responseText);
            }
        });
    });

    $(document).on("click", ".delete-comment-btn", function () {
        if (!confirm("ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;

        const commentId = $(this).data("comment-id");

        // Î©îÌÉÄ ÌÉúÍ∑∏ÏóêÏÑú CSRF ÌÜ†ÌÅ∞Í≥º Ìó§Îçî Ïù¥Î¶ÑÏùÑ Í∞ÄÏ†∏Ïò¥
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: `/comment/delete/${commentId}`,
            type: "POST",
            headers: {
                [csrfHeader]: csrfToken  // ‚Üê Ìó§ÎçîÏóê Îã¥Í∏∞
            },
            success: function () {
                $(`#comment-${commentId}`).remove();
            },
            error: function () {
                alert("ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®");
            }
        });
    });


    // ÎãµÍ∏Ä Îã¨Í∏∞ Î≤ÑÌäº ÎàåÎ†ÄÏùÑ Îïå ÏûÖÎ†•Ï∞Ω Î≥¥Ïó¨Ï£ºÍ∏∞
    $(document).on("click", ".reply-btn", function () {
        const parentId = $(this).data("parent-id");
        $(`#reply-form-${parentId}`).toggleClass("d-none");
    });

    // ÎãµÍ∏Ä Îì±Î°ù Ï≤òÎ¶¨
    $(document).on("click", ".submit-reply", function () {
        const $form = $(this).closest(".reply-form");
        const parentId = $form.attr("id").split("-")[2];
        const content = $form.find(".reply-content").val();
        const postId = $("#commentPostID").val();
        const csrfToken = $("input[name='_csrf']").val();

        $.ajax({
            url: "/comment/reply",
            type: "POST",
            data: {
                postId: postId,
                parentId: parentId,
                content: content,
                _csrf: csrfToken
            },
            success: function () {
                const replyHtml = `
                <div class="ms-4 border-start ps-2 mt-2">
                    <img src="/img/default-profile.png" class="rounded-circle me-2" style="width:30px; height:30px;">
                    <strong>ÎÇò</strong>
                    <div>${content}</div>
                    <div class="text-muted">${new Date().toLocaleString()}</div>
                    <hr>
                </div>`;
                $(`#reply-form-${parentId}`).before(replyHtml);
                $form.find(".reply-content").val("");
                $form.addClass("d-none");
            },
            error: function () {
                alert("ÎãµÍ∏Ä Îì±Î°ù Ïã§Ìå®");
            }
        });
    });

    $(document).on("click", ".like-btn", function () {
        const $btn = $(this);
        const postId = $btn.data("post-id");

        $.ajax({
            url: `/post/vote/${postId}`,
            type: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            success: function () {
                // ÌòÑÏû¨ ÌïòÌä∏ ÏÉÅÌÉú ÏùΩÍ∏∞
                const liked = $btn.data("liked");
                let count = parseInt($btn.data("like-count"));

                // ÏÉÅÌÉú ÌÜ†Í∏Ä
                const newLiked = !liked;
                const newCount = newLiked ? count + 1 : count - 1;

                // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                $btn.data("liked", newLiked);
                $btn.data("like-count", newCount);

                // ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                $btn.html(`${newLiked ? "üß°" : "ü§ç"} ${newCount}`);
            },
            error: function () {
                alert("Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ïã§Ìå®!");
            }
        });
    });

</script>


</body>
</html>
