<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main-layout}"
      layout:fragment="content">
<link rel="stylesheet" th:href="@{/css/community.css}">
<body class="bg-light">

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
        <div>
            <a class="feed-tab active" th:href="@{/post/feed/list}">ì§€ê¸ˆ í”¼ë“œ</a>
            <a class="feed-tab non-active" th:href="@{/post/review/list}">ëª¨ì„ í›„ê¸°</a>
        </div>
        <a th:href="@{/post/feed/create}" class="btn" id="write-btn">í”¼ë“œ ì“°ê¸°</a>
    </div>


    <!-- ê²€ìƒ‰ ì°½ -->
    <div class="row">
        <div class="col mt-3">
            <form class="d-flex align-items-right" role="search" th:action="@{/post/feed/list}" method="get">
                <input type="text" class="form-control search-bar" name="keyword" placeholder="ì œëª©, ë‚´ìš©, ì‘ì„±ì, íƒœê·¸ë¡œ ê²€ìƒ‰í•˜ê¸°">
            </form>
        </div>
    </div>

    <!-- íƒ­ ì»¨í…ì¸  -->
    <div class="tab-content" id="communityTabContent">
        <!-- ì§€ê¸ˆ í”¼ë“œ -->
        <div class="tab-pane fade show active" id="feed-tab-pane" role="tabpanel" aria-labelledby="feed-tab"
             tabindex="0">
            <div class="row row-cols-1 row-cols-md-2 g-4 mt-3" id="feed-container"
                 data-masonry='{"percentPosition": true }'>
                <div class="col" th:each="post : ${postList}">
                    <div class="post-card">
                        <div class="d-flex align-items-center">
                            <img th:src="${post.author.profileImage != null ? post.author.profileImage : '/img/default-profile.png'}"
                                 class="rounded-circle me-2 img-fluid" style="width: 40px; height: 40px;">
                            <div>
                                <div class="post-author" th:text="${post.author.name}">ì‘ì„±ì</div>
                                <div class="post-time" th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <img th:if="${post.imageURL != null and !post.imageURL.isEmpty()}" th:src="${post.imageURL}" class="img-fluid rounded mb-2" alt="í”¼ë“œ ì´ë¯¸ì§€"
                                 style="width: 100%; height:auto;">
                            <h5 th:text="${post.title}">ì œëª©</h5>
                            <p class="mb-2" th:text="${post.content}">ë‚´ìš©</p>
                            <div class="hashtags">
                                <a th:each="tag : ${post.tagList}"
                                   th:href="@{'/post/feed/list?keyword=' + ${tag}}"
                                   th:text="'#' + ${tag}"
                                   class="me-1 text-decoration-none text-muted hashtag"></a>
                            </div>
                        </div>

                        <div class="icons mt-3">
                            <a href="javascript:void(0);"
                               class="like-btn text-decoration-none"
                               th:data-post-id="${post.postID}"
                               th:data-liked="${post.voter.contains(loginUser)}"
                               th:data-like-count="${#lists.size(post.voter)}">
                                <span th:if="${post.voter.contains(loginUser)}" th:text="'ğŸ§¡' + ${#lists.size(post.voter)}"></span>
                                <span th:unless="${post.voter.contains(loginUser)}" th:text="'ğŸ¤' + ${#lists.size(post.voter)}"></span>
                            </a>
                            <span class="ms-3 comment-toggle" th:attr="data-post-id=${post.postID}">
                    ğŸ’¬ <span th:text="${commentCountMap[post.postID]}">0</span>
                </span>
                        </div>

                        <div class="mt-2 d-flex justify-content-end"
                             th:if="${loginUser != null and loginUser.id == post.author.id}">
                            <a th:href="@{'/post/modify/' + ${post.postID}}" class="btn btn-sm btn-outline-secondary me-2">ìˆ˜ì •</a>
                            <a th:href="@{'/post/delete/' + ${post.postID}}" class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                        </div>
                    </div>
                </div>
            </div>


            <div class="text-center mt-4" th:if="${hasMore}">
                <button id="loadMoreBtn" class="btn btn-outline-primary mb-5">ë”ë³´ê¸°</button>
            </div>
        </div>

        <!-- ëŒ“ê¸€ ëª¨ë‹¬ -->
        <div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ëŒ“ê¸€</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                    </div>
                    <div class="modal-body">

                        <!-- ëŒ“ê¸€ ëª©ë¡ -->
                        <div th:each="post : ${postList}" th:id="'comment-list-' + ${post.postID}" class="comment-list d-none">
                            <div th:each="comment : ${commentMap[post.postID]}"
                                 th:id="'comment-' + ${comment.id}" class="mb-3">

                                <!-- í”„ë¡œí•„ ë° ì‘ì„±ì -->
                                <div>
                                    <img th:src="${comment.author.profileImage != null ? comment.author.profileImage : '/img/default-profile.png'}"
                                         class="rounded-circle me-2" style="width:30px; height:30px;">
                                    <strong th:text="${comment.author.name}">ì‘ì„±ì</strong>
                                </div>

                                <!-- ëŒ“ê¸€ ë³¸ë¬¸ -->
                                <div class="comment-content" th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</div>
                                <div class="text-muted small" th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</div>

                                <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
                                <div th:if="${loginUser != null and loginUser.id == comment.author.id}">
                                    <button type="button" class="btn btn-sm btn-outline-secondary edit-comment-btn"
                                            th:data-comment-id="${comment.id}">ìˆ˜ì •</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-comment-btn"
                                            th:data-comment-id="${comment.id}" th:data-post-id="${post.postID}">ì‚­ì œ</button>
                                </div>

                                <!-- ë‹µê¸€ ë²„íŠ¼ -->
                                <button type="button" class="btn btn-sm btn-link reply-btn" th:data-parent-id="${comment.id}">ë‹µê¸€</button>

                                <!-- ë‹µê¸€ í¼ -->
                                <div th:id="'reply-form-' + ${comment.id}" class="reply-form mt-2 d-none">
                                    <textarea class="form-control reply-content" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                    <button type="button" class="btn btn-sm btn-primary mt-1 submit-reply">ë“±ë¡</button>
                                </div>

                                <!-- ëŒ€ëŒ“ê¸€ -->
                                <div th:each="child : ${comment.children}"
                                     th:id="'comment-' + ${child.id}"
                                     class="ms-4 border-start ps-3 mt-3">

                                    <img th:src="${child.author.profileImage != null ? child.author.profileImage : '/img/default-profile.png'}"
                                         class="rounded-circle me-2" style="width:30px; height:30px;">
                                    <strong th:text="${child.author.name}">ì‘ì„±ì</strong>

                                    <div class="comment-content" th:text="${child.content}">ë‹µê¸€ ë‚´ìš©</div>
                                    <div class="text-muted small" th:text="${#temporals.format(child.createDate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</div>

                                    <div th:if="${loginUser != null and loginUser.id == child.author.id}">
                                        <button type="button" class="btn btn-sm btn-outline-secondary edit-comment-btn"
                                                th:data-comment-id="${child.id}">ìˆ˜ì •</button>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-comment-btn"
                                                th:data-comment-id="${child.id}" th:data-post-id="${post.postID}">ì‚­ì œ</button>
                                    </div>
                                </div>
                                <hr>
                            </div>
                        </div>

                        <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                        <form id="commentForm" class="mt-3">
                            <input type="hidden" id="commentPostID" name="postID" />
                            <textarea id="commentContent" name="content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                            <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-primary mt-2">ëŒ“ê¸€ ë“±ë¡</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>


    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script layout:fragment="script">
    $(function () {
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        $(document).ajaxSend(function (e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });
    });

    let msnry;

    // Masonry ìˆ˜ë™ ì´ˆê¸°í™” (í˜ì´ì§€ ì²˜ìŒ ë¡œë“œë  ë•Œ)
    $(window).on('load', function () {
        imagesLoaded('#feed-container', function () {
            msnry = new Masonry('#feed-container', {
                itemSelector: '.col',
                percentPosition: true
            });
        });
    });

    let offset = 4;
    const limit = 4;
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    // "ë”ë³´ê¸°" ë²„íŠ¼ì´ ì¡´ì¬í•  ë•Œë§Œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener("click", function () {
            $.ajax({
                url: "/post/feed/more",
                type: "GET",
                data: { offset, limit },
                success: function (posts) {
                    if (posts.length === 0) {
                        $("#loadMoreBtn").hide();
                        return;
                    }

                    const newElems = [];

                    posts.forEach(post => {
                        if (post.boardType !== "FEED") return;
                        const $newCard = $(`
                        <div class="col">
                            <div class="post-card">
                                <div class="d-flex align-items-center">
                                    <img src="${post.authorProfileImage || '/img/default-profile.png'}" class="rounded-circle me-2 img-fluid" style="width: 40px; height: 40px;">
                                    <div>
                                        <div class="post-author">${post.authorName}</div>
                                        <div class="post-time">${new Date(post.createDate).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <img src="${post.imageURL}" class="img-fluid rounded mb-2" alt="í”¼ë“œ ì´ë¯¸ì§€" style="width: 100%; height:auto;">
                                    <h5>${post.title}</h5>
                                    <p class="mb-2">${post.content}</p>
                                    <div class="hashtags">
                                        ${
                            post.tags.split(',').map(tag =>
                                `<a href="/post/feed/list?keyword=${tag.trim()}" class="me-1 text-decoration-none text-muted hashtag">#${tag.trim()}</a>`
                            ).join('')
                        }
                                    </div>
                                </div>
                                <div class="icons mt-3">
                                    <span>ğŸ¤ 0</span>
                                    <span class="ms-3">ğŸ’¬ 0</span>
                                </div>
                            </div>
                        </div>
                    `);

                        $("#feed-container").append($newCard);
                        newElems.push($newCard[0]);
                    });

                    imagesLoaded('#feed-container', function () {
                        msnry.appended(newElems);
                        msnry.layout(); // ì •í™•í•œ ë†’ì´ ê³„ì‚°
                    });

                    offset += posts.length;

                    if (posts.length < limit) {
                        $("#loadMoreBtn").hide();
                    }
                },
                error: function () {
                    alert("í”¼ë“œë¥¼ ë” ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });
    } else {
        console.log("ë”ë³´ê¸° ë²„íŠ¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }



    $(document).ready(function () {


        // ëŒ“ê¸€ ëª¨ë‹¬ ì—´ê¸°
        $(".comment-toggle").on("click", function () {
            const postID = $(this).data("post-id");
            $("#commentPostID").val(postID);

            $(".comment-list").addClass("d-none");
            $(`#comment-list-${postID}`).removeClass("d-none");

            const modal = new bootstrap.Modal(document.getElementById('commentModal'));
            modal.show();
        });

        // ëŒ“ê¸€ ë“±ë¡
        $("#commentForm").on("submit", function (e) {
            e.preventDefault();

            const postID = $("#commentPostID").val();
            const content = $("#commentContent").val();

            const csrfToken = $("meta[name='_csrf']").attr("content");
            const csrfHeader = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: "/comment",
                type: "POST",
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                headers: {
                    [csrfHeader]: csrfToken
                },
                data: {
                    postID: postID,
                    content: content
                },
                success: function () {
                    const commentHtml = `
                        <strong>ë‚˜</strong>
                        <div>${content}</div>
                        <div class="text-muted">${new Date().toLocaleString()}</div>
                        <hr>
                    `;
                    $(`#comment-list-${postID}`).append(commentHtml);
                    $("#commentContent").val(""); // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                },
                error: function (xhr) {
                    console.log("ìƒíƒœ ì½”ë“œ:", xhr.status);
                    console.log("ì‘ë‹µ í…ìŠ¤íŠ¸:", xhr.responseText);
                    alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + xhr.status);
                }
            });
        });
    });

    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ì°½ í† ê¸€
    $(document).on("click", ".edit-comment-btn", function () {
        const commentId = $(this).data("comment-id");
        const $commentDiv = $(`#comment-${commentId}`);
        const originalContent = $commentDiv.find(".comment-content").text();

        const editForm = `
        <div class="edit-form mt-2">
            <textarea class="form-control edit-content" rows="2">${originalContent}</textarea>
            <button class="btn btn-sm btn-primary mt-1 submit-edit" data-comment-id="${commentId}">ìˆ˜ì • ì™„ë£Œ</button>
        </div>`;

        $commentDiv.append(editForm);
    });

    $(document).on("click", ".submit-edit", function () {
        const commentId = $(this).data("comment-id");
        const newContent = $(this).siblings(".edit-content").val();

        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        const csrfToken = $("meta[name='_csrf']").attr("content");

        $.ajax({
            url: `/comment/edit/${commentId}`,
            type: "POST",
            data: {
                content: newContent,
                _csrf: csrfToken
            },
            success: function () {
                // í™”ë©´ ì—…ë°ì´íŠ¸
                const $commentBlock = $(`#comment-${commentId}`);
                $commentBlock.find(".comment-content").text(newContent);
                $commentBlock.find(".edit-form").remove();
            },
            error: function (xhr) {
                alert("ìˆ˜ì • ì‹¤íŒ¨: " + xhr.responseText);
            }
        });
    });

    $(document).on("click", ".delete-comment-btn", function () {
        if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;

        const commentId = $(this).data("comment-id");

        // ë©”íƒ€ íƒœê·¸ì—ì„œ CSRF í† í°ê³¼ í—¤ë” ì´ë¦„ì„ ê°€ì ¸ì˜´
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: `/comment/delete/${commentId}`,
            type: "POST",
            headers: {
                [csrfHeader]: csrfToken  // â† í—¤ë”ì— ë‹´ê¸°
            },
            success: function () {
                $(`#comment-${commentId}`).remove();
            },
            error: function () {
                alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨");
            }
        });
    });


    // ë‹µê¸€ ë‹¬ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ì…ë ¥ì°½ ë³´ì—¬ì£¼ê¸°
    $(document).on("click", ".reply-btn", function () {
        const parentId = $(this).data("parent-id");
        $(`#reply-form-${parentId}`).toggleClass("d-none");
    });

    // ë‹µê¸€ ë“±ë¡ ì²˜ë¦¬
    $(document).on("click", ".submit-reply", function () {
        const $form = $(this).closest(".reply-form");
        const parentId = $form.attr("id").split("-")[2];
        const content = $form.find(".reply-content").val();
        const postId = $("#commentPostID").val();
        const csrfToken = $("input[name='_csrf']").val();

        $.ajax({
            url: "/comment/reply",
            type: "POST",
            data: {
                postId: postId,
                parentId: parentId,
                content: content,
                _csrf: csrfToken
            },
            success: function () {
                const replyHtml = `
                <div class="ms-4 border-start ps-2 mt-2">
                    <img src="/img/default-profile.png" class="rounded-circle me-2" style="width:30px; height:30px;">
                    <strong>ë‚˜</strong>
                    <div>${content}</div>
                    <div class="text-muted">${new Date().toLocaleString()}</div>
                    <hr>
                </div>`;
                $(`#reply-form-${parentId}`).before(replyHtml);
                $form.find(".reply-content").val("");
                $form.addClass("d-none");
            },
            error: function () {
                alert("ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨");
            }
        });
    });

    $(document).on("click", ".like-btn", function () {
        const $btn = $(this);
        const postId = $btn.data("post-id");

        $.ajax({
            url: `/post/vote/${postId}`,
            type: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            success: function () {
                // í˜„ì¬ í•˜íŠ¸ ìƒíƒœ ì½ê¸°
                const liked = $btn.data("liked");
                let count = parseInt($btn.data("like-count"));

                // ìƒíƒœ í† ê¸€
                const newLiked = !liked;
                const newCount = newLiked ? count + 1 : count - 1;

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                $btn.data("liked", newLiked);
                $btn.data("like-count", newCount);

                // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                $btn.html(`${newLiked ? "ğŸ§¡" : "ğŸ¤"} ${newCount}`);
            },
            error: function () {
                alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨!");
            }
        });
    });

</script>


</body>
</html>
