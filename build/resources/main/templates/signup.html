<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main-layout}"
      layout:fragment="content">
<link th:href="@{/css/signup.css}" rel="stylesheet"/>
<link th:href="@{/font/font.css}" rel="stylesheet" type="text/css"/>

<style>

    .form-check {
        margin: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
    }

    .form-check-input.custom-check {
        display: none; /* ê¸°ë³¸ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¹€ */
    }

    .form-check-label.btn {
        transition: all 0.2s;
        user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
    }

    .form-check-input:checked + .form-check-label.btn, .btn-custom-signup:hover {
        background-color: #d55e0e; /* ì„ íƒ ì‹œ ë°°ê²½ìƒ‰ */
        color: white; /* ì„ íƒ ì‹œ ê¸€ììƒ‰ */
    }

.btn-custom-signup {
    font-family: 'Pretendard-Medium';
        height:60px;width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

</style>
<body>
<div class="container d-flex justify-content-center align-items-center min-vh-80 my-5">
    <div class="profile-card  col-md-8 col-lg-11 p-4 ">
        <h4 class="text-center my-5">íšŒì›ê°€ì…</h4>

        <form th:object="${userCreateForm}" th:action="@{/signup}" method="post" enctype="multipart/form-data">
            <input type="hidden" id="clientKey" name="clientKey" th:field="*{clientKey}"/>
            <input type="hidden" id="otpVerified" name="otpVerified" th:field="*{otpVerified}"/>
            <div style="position: relative;">
                <!--            í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ-->
                <div class="mb-4 text-center profile-container " style="border: #d55e0e solid 1px;">
                    <label for="profile-upload" class="profile-label">
                        <img id="profile-preview" th:src="@{/img/default-profile.png}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
                             class="profile-img w-100 h-100">
                    </label>
                    <input type="file" id="profile-upload" name="profileImage" accept="image/*" style="display: none;">
                </div>
                <div><label for="profile-upload">
                    <img th:src="@{/img/svg/1-icon.svg}" alt="ì—…ë¡œë“œ ì•„ì´ì½˜" class="upload-icon "
                         style="width: 40px; height: 40px; position: absolute; top: 120px; right: 90px; z-index: 9999;">
                </label></div>


            </div>


            <div class="mb-4 text-start">
                <label for="name" class="form-label">ì´ë¦„</label>
                <input type="text" class="form-control" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" th:field="*{name}">
                <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="text-danger"></span>
            </div>
            <div class="mb-4 text-start">
                <label for="introduction" class="form-label">ìê¸°ì†Œê°œ</label>
                <input type="text" class="form-control" id="introduction" placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       th:field="*{introduction}">
                <span th:if="${#fields.hasErrors('introduction')}" th:errors="*{introduction}"
                      class="text-danger"></span>
            </div>
            <div class="mb-4 text-start">
                <label for="email" class="form-label">ì´ë©”ì¼</label>
                <input type="email" class="form-control" id="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" th:field="*{email}">
                <span th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="text-danger"></span>
            </div>
            <div class="mb-4 text-start">
                <label for="password1" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-control" id="password1" name="password1"
                       placeholder="ì˜ë¬¸ì/íŠ¹ìˆ˜ë¬¸ì/ìˆ«ì í¬í•¨ 8~20ì" th:field="*{password1}">
                <span th:if="${#fields.hasErrors('password1')}" th:errors="*{password1}" class="text-danger"></span>
            </div>
            <div class="mb-4 text-start">
                <label for="password2" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" class="form-control" id="password2" name="password2"
                       placeholder="ì˜ë¬¸ì/íŠ¹ìˆ˜ë¬¸ì/ìˆ«ì í¬í•¨ 8~20ì" th:field="*{password2}">
                <span th:if="${#fields.hasErrors('password2')}" th:errors="*{password2}" class="text-danger"></span>
            </div>

            <!-- ìƒë…„ì›”ì¼/ì„±ë³„ -->
            <div class="mb-4 text-start" id="birthDaySection">
                <label class="form-label">ìƒë…„ì›”ì¼/ì„±ë³„</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="birthDay1" name="birthDay1" th:field="*{birthDay1}"
                           placeholder="YYMMDD" maxlength="6"/>
                    <span class="input-group-text border-0">-</span>
                    <input type="text" class="form-control" id="birthDay2" name="birthDay2" th:field="*{birthDay2}"
                           placeholder="ì„±ë³„(1~4)" maxlength="1"/>
                </div>
                <span th:if="${#fields.hasErrors('birthDay1')}" th:errors="*{birthDay1}" class="text-danger"></span>
                <span th:if="${#fields.hasErrors('birthDay2')}" th:errors="*{birthDay2}" class="text-danger"></span>
            </div>

            <!-- ê´€ì‹¬ í‚¤ì›Œë“œ ì„ íƒ -->
            <!-- ê´€ì‹¬ í‚¤ì›Œë“œ ì„ íƒ -->
            <div class="mb-4 text-start">
                <label class="form-label create-name text-dark">ë‚˜ì˜ ê´€ì‹¬ í‚¤ì›Œë“œ(ìµœëŒ€3ê°œ ì„ íƒê°€ëŠ¥)</label>
                <div class="row row-cols-3 row-cols-lg-6 g-2">
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input custom-check shadow-sm" type="checkbox" name="theme[]" value="ì•¡í‹°ë¹„í‹°"
                                   id="theme1">
                            <label class="form-check-label btn btn-custom-signup fs-6 fs-md-2 " for="theme1">ì•¡í‹°ë¹„í‹°
                                ğŸƒ</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input custom-check" type="checkbox" name="theme[]" value="ìê¸°ê³„ë°œ"
                                   id="theme2">
                            <label class="form-check-label btn btn-custom-signup fs-6 fs-md-2" for="theme2">ìê¸°ê³„ë°œ
                                ğŸ“š</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input custom-check" type="checkbox" name="theme[]" value="ì·¨ë¯¸"
                                   id="theme3">
                            <label class="form-check-label btn btn-custom-signup fs-6 fs-md-2" for="theme3">ì·¨ë¯¸ ğŸ®</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input custom-check" type="checkbox" name="theme[]" value="ì—¬í–‰"
                                   id="theme4">
                            <label class="form-check-label btn btn-custom-signup fs-6 fs-md-2" for="theme4">ì—¬í–‰
                                âœˆï¸</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input custom-check" type="checkbox" name="theme[]" value="ë¬¸í™”/ì˜ˆìˆ "
                                   id="theme5">
                            <label class="form-check-label btn btn-custom-signup fs-6 fs-md-2" for="theme5">ë¬¸í™”/ì˜ˆìˆ 
                                ğŸ­</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input custom-check" type="checkbox" name="theme[]" value="í‘¸ë“œ/ë“œë§í¬"
                                   id="theme6">
                            <label class="form-check-label btn btn-custom-signup fs-6 fs-md-2" for="theme6">í‘¸ë“œ/ë“œë§í¬
                                ğŸ”</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì „í™”ë²ˆí˜¸ ë° í†µì‹ ì‚¬ ì„ íƒ -->
            <div class="mb-4 text-start" id="cellCorpSection">
                <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                <div class="input-group">
                    <select class="form-select" id="cellCorp" th:field="*{cellCorp}">
                        <option value="">í†µì‹ ì‚¬ ì„ íƒ</option>
                        <option value="KTF">KT</option>
                        <option value="SKT">SKT</option>
                        <option value="LGT">LGU</option>
                    </select>
                    <input type="text" class="form-control" id="phone" name="phone" th:field="*{phone}"
                           placeholder="01012345678"/>
                    <button type="button" class="btn btn-outline-secondary" id="sendOtpBtn">ì¸ì¦ë²ˆí˜¸ ì „ì†¡</button>
                </div>
                <span th:if="${#fields.hasErrors('cellCorp')}" th:errors="*{cellCorp}" class="text-danger"></span>
                <span th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}" class="text-danger"></span>
            </div>
            <!-- OTP ì…ë ¥ í•„ë“œ -->
            <div class="mb-4 text-start" id="otpSection" style="display: none;">
                <label class="form-label">ì¸ì¦ë²ˆí˜¸</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="otpInput" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬ ì…ë ¥" maxlength="6"/>
                    <button type="button" class="btn btn-outline-secondary" id="verifyOtpBtn">ì¸ì¦ë²ˆí˜¸ í™•ì¸</button>
                </div>
                <span id="otpError" class="text-danger" style="display: none;"></span>

            </div>
            <!-- ë³´ì•ˆë¬¸ì -->
            <div class="mb-4 text-start" id="captchaSection">
                <label>ë³´ì•ˆë¬¸ì</label>
                <div class="input-group">
                    <img id="captchaImage" class="img-fluid mb-0" alt="Captcha Image" style="height: 40px;"/>
                    <input type="text" class="form-control" id="captchaInput" th:field="*{captchaInput}"
                           placeholder="ë³´ì•ˆë¬¸ì ì…ë ¥" minlength="6" maxlength="6"/>
                    <button type="button" class="btn btn-outline-secondary" id="captchaReloadBtn">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <span th:if="${#fields.hasErrors('captchaInput')}" th:errors="*{captchaInput}"
                      class="text-danger"></span>
            </div>

            <button type="submit" class="btn-save btn w-100">ì €ì¥</button>
        </form>
    </div>
</div>
<script layout:fragment="script">
    $(function () {

        $('#profile-upload').on('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#profile-preview').attr('src', e.target.result); // ì´ë¯¸ì§€ src ë³€ê²½
                };
                reader.readAsDataURL(file);
            }
        });


        let clientKey = $('#clientKey').val();
        let _csrf = $('input[name=_csrf]').val();

        let cnt = 0;
        loadCaptcha(false);

        $('#captchaReloadBtn').click(function () {
            cnt++;
            console.log("Captcha reload count: " + cnt);
            loadCaptcha(true);
        });

        function loadCaptcha(includeCnt) {
            let data = {clientKey: clientKey, _csrf: _csrf};
            if (includeCnt) {
                data.cnt = cnt;
            }

            $.ajax({
                url: '/get-captcha',
                type: 'POST',
                data: data,
                success: function (response) {
                    $('#captchaImage').attr('src', response);
                },
                error: function (xhr, status, error) {
                    console.error('ìº¡ì°¨ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
                }
            });
        }

        $('#sendOtpBtn').click(function () {
            let name = $('#name').val();
            let birthDay1 = $('#birthDay1').val();
            let birthDay2 = $('#birthDay2').val();
            let cellCorp = $('#cellCorp').val();
            let phone = $('#phone').val();
            let captchaInput = $('#captchaInput').val();

            // ê°œë³„ í•„ë“œ ê²€ì¦
            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#name').focus();
                return;
            }

            if (!birthDay1) {
                alert('ìƒë…„ì›”ì¼(YYMMDD)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#birthDay1').focus();
                return;
            }

            if (!birthDay2) {
                alert('ì„±ë³„(1~4)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#birthDay2').focus();
                return;
            }

            if (!cellCorp) {
                alert('í†µì‹ ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                $('#cellCorp').focus();
                return;
            }

            if (!phone) {
                alert('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#phone').focus();
                return;
            }

            if (!captchaInput) {
                alert('ë³´ì•ˆë¬¸ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#captchaInput').focus();
                return;
            }

            $.ajax({
                url: '/send-otp',
                type: 'POST',
                data: {
                    clientKey: clientKey,
                    name: name,
                    birthDay1: birthDay1,
                    birthDay2: birthDay2,
                    cellCorp: cellCorp,
                    phone: phone,
                    captchaInput: captchaInput,
                    _csrf: _csrf
                },
                success: function (response) {
                    alert(response); // "OTPê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."
                    $('#otpSection').show(); // OTP ì…ë ¥ í•„ë“œ í‘œì‹œ
                },
                error: function (xhr, status, error) {
                    console.error('OTP ì „ì†¡ ì‹¤íŒ¨:', error);
                    alert(xhr.responseText); // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    if (xhr.responseText === "OTP ì „ì†¡ ì‹¤íŒ¨: ë³´ì•ˆë¬¸ìë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.") {
                        cnt++;
                        console.log("Captcha reload count: " + cnt);
                        loadCaptcha(true);
                    }
                }
            });
        });
        $('#verifyOtpBtn').click(function () {
            let otpInput = $('#otpInput').val();

            if (!otpInput) {
                alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#otpInput').focus();
                return;
            }
            if (otpInput.length !== 6) {
                alert('ì¸ì¦ë²ˆí˜¸ëŠ” 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                $('#otpInput').focus();
                return;
            }

            $.ajax({
                url: '/check-otp',
                type: 'POST',
                data: {
                    clientKey: clientKey,
                    otpInput: otpInput,
                    _csrf: _csrf
                },
                success: function (response) {
                    alert(response);
                    $('#otpSection').hide();
                    $('#captchaSection').hide();
                    $('#birthDaySection').hide();
                    $('#cellCorpSection').hide();
                    $('#phone').prop('readonly', true);
                    $('#sendOtpBtn').prop('disabled', true);
                    $('#cellCorp').prop('readonly', true);
                    $('#birthDay1').prop('readonly', true);
                    $('#birthDay2').prop('readonly', true);
                    $('#otpVerified').val('true');
                },
                error: function (xhr) {
                    $('#otpError').text(xhr.responseText).show();
                }
            });
        });

        document.querySelectorAll('.custom-check').forEach(check => {
            check.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('.custom-check:checked').length;
                if (checkedCount > 3) { // ìµœëŒ€ 3ê°œ ì œí•œ ì˜ˆì‹œ
                    check.checked = false;
                    alert('ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
                }
            });
        });
    })

</script>

</body>

</html>